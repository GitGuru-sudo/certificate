<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Certificate Lookup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <h2>Get Certificate Data</h2>

  <!-- Enrollment input -->
  <input type="text" id="enrollment" placeholder="Enter Enrollment ID">

  <!-- Event dropdown -->
  <select id="eventDropdown">
    <option value="">-- Select Event --</option>
  </select>

  <button onclick="getCertificate()">Fetch</button>

  <div id="result" style="margin-top:20px; border:1px solid #ccc; padding:10px;"></div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script>
    // ✅ Replace with your Supabase project credentials
    const SUPABASE_URL = "https://zgcyqufccguiustbufkl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpnY3lxdWZjY2d1aXVzdGJ1ZmtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMDYwMDIsImV4cCI6MjA3MjU4MjAwMn0.JvgLWYQ4zh_uBA3gwznBQWEJV5_E9oRXnBukKMVtpZ8";


    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Load events into dropdown on page load
    async function loadEvents() {
      const { data: events, error } = await supabaseClient
        .from("events")
        .select("event_name");

      if (error) {
        console.error("Error loading events:", error);
        return;
      }

      const dropdown = document.getElementById("eventDropdown");
      events.forEach(evt => {
        let option = document.createElement("option");
        option.value = evt.event_name;
        option.textContent = evt.event_name;
        dropdown.appendChild(option);
      });
    }

    // Fetch student + validate event
    async function getCertificate() {
      const enrollment = document.getElementById("enrollment").value.trim();
      const eventName = document.getElementById("eventDropdown").value.trim();

      if (!enrollment || !eventName) {
        document.getElementById("result").innerHTML = `<p style="color:red">Please enter enrollment and select event</p>`;
        return;
      }

      // 1. Validate event exists
      const { data: event, error: eventError } = await supabaseClient
        .from("events")
        .select("id")
        .eq("event_name", eventName)
        .single();

      if (eventError || !event) {
        document.getElementById("result").innerHTML = `<p style="color:red">Event not found</p>`;
        return;
      }

      // 2. Fetch student (only name + course)
      const { data: student, error: studentError } = await supabaseClient
        .from("students")
        .select("name, course")
        .eq("enrollment", enrollment)
        .single();

      if (studentError || !student) {
        document.getElementById("result").innerHTML = `<p style="color:red">Student not found</p>`;
        return;
      }

      // ✅ Show result
      document.getElementById("result").innerHTML = `
        <h3>Certificate Data</h3>
        <p><b>Name:</b> ${student.name}</p>
        <p><b>Course:</b> ${student.course}</p>
      `;
    }

    // Load events when page starts
    loadEvents();
  </script>
</body>
</html>
