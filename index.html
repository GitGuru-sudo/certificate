<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Certificate Lookup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- JS libraries for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <h2>Get Certificate Data</h2>

  <!-- Enrollment input -->
  <input type="text" id="enrollment" placeholder="Enter Enrollment ID">

  <!-- Event dropdown -->
  <select id="eventDropdown">
    <option value="">-- Select Event --</option>
  </select>

  <button onclick="getCertificate()">Fetch</button>

  <div id="result" style="margin-top:20px; border:1px solid #ccc; padding:10px;"></div>

  <!-- Download button -->
  <button onclick="downloadCertificate()">Download Certificate</button>

  <!-- Hidden certificate render area -->
  <div id="certificateArea" style="position:relative;width:800px;height:600px;display:none;">
    <img id="certTemplate" src="template.png" style="position:absolute;top:0;left:0;width:800px;height:600px;"/>
    <div id="certText" style="position:absolute;top:250px;left:0;width:800px;text-align:center;">
      <div id="certName" style="font-size:32px;font-weight:bold;color:#222;"></div>
      <div id="certCourse" style="font-size:24px;color:#444;margin-top:16px;"></div>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script>
    // ✅ Replace with your Supabase project credentials
    const SUPABASE_URL = "https://zgcyqufccguiustbufkl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpnY3lxdWZjY2d1aXVzdGJ1ZmtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMDYwMDIsImV4cCI6MjA3MjU4MjAwMn0.JvgLWYQ4zh_uBA3gwznBQWEJV5_E9oRXnBukKMVtpZ8";


    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Load events into dropdown on page load
    async function loadEvents() {
      const { data: events, error } = await supabaseClient
        .from("events")
        .select("event_name");

      if (error) {
        console.error("Error loading events:", error);
        return;
      }

      const dropdown = document.getElementById("eventDropdown");
      events.forEach(evt => {
        let option = document.createElement("option");
        option.value = evt.event_name;
        option.textContent = evt.event_name;
        dropdown.appendChild(option);
      });
    }

    // Fetch student + validate event
    async function getCertificate() {
      const enrollment = document.getElementById("enrollment").value.trim();
      const eventName = document.getElementById("eventDropdown").value.trim();

      if (!enrollment || !eventName) {
        document.getElementById("result").innerHTML = `<p style="color:red">Please enter enrollment and select event</p>`;
        return;
      }

      // 1. Validate event exists
      const { data: event, error: eventError } = await supabaseClient
        .from("events")
        .select("id")
        .eq("event_name", eventName)
        .single();

      if (eventError || !event) {
        document.getElementById("result").innerHTML = `<p style="color:red">Event not found</p>`;
        return;
      }

      // 2. Fetch student (only name + course)
      const { data: student, error: studentError } = await supabaseClient
        .from("students")
        .select("name, course")
        .eq("enrollment", enrollment)
        .single();

      if (studentError || !student) {
        document.getElementById("result").innerHTML = `<p style="color:red">Student not found</p>`;
        return;
      }

      // ✅ Show result
      document.getElementById("result").innerHTML = `
        <h3>Certificate Data</h3>
        <p><b>Name:</b> ${student.name}</p>
        <p><b>Course:</b> ${student.course}</p>
      `;

      // Update certificate preview
      document.getElementById("certName").textContent = student.name;
      document.getElementById("certCourse").textContent = student.course;
      document.getElementById("certificateArea").style.display = "block";
    }

    // Download certificate as PDF
    async function downloadCertificate() {
      const enrollment = document.getElementById("enrollment").value.trim();
      const eventName = document.getElementById("eventDropdown").value.trim();

      if (!enrollment || !eventName) {
        document.getElementById("result").innerHTML = `<p style="color:red">Please enter enrollment and select event</p>`;
        return;
      }

      // Fetch student
      const { data: student, error: studentError } = await supabaseClient
        .from("students")
        .select("name, course")
        .eq("enrollment", enrollment)
        .single();

      if (studentError || !student) {
        document.getElementById("result").innerHTML = `<p style="color:red">Student not found</p>`;
        return;
      }

      // Set certificate text
      document.getElementById("certName").textContent = student.name;
      document.getElementById("certCourse").textContent = student.course;

      // Wait for image to load
      const img = document.getElementById("certTemplate");
      if (!img.complete) {
        await new Promise(resolve => { img.onload = resolve; });
      }

      // Show certificate area for rendering
      const certArea = document.getElementById("certificateArea");
      certArea.style.display = "block";

      // Render to canvas and download PDF
      html2canvas(certArea).then(canvas => {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF("l", "pt", [canvas.width, canvas.height]);
        pdf.addImage(canvas.toDataURL("image/png"), "PNG", 0, 0, canvas.width, canvas.height);
        pdf.save(`${student.name}_certificate.pdf`);
        certArea.style.display = "none";
      });
    }

    // Load events when page starts
    loadEvents();
  </script>
</body>
</html>
